{% extends "base.html" %}

{% block title %}Transactions - Money Tracker{% endblock %}

{% block content %}
<div class="transactions-page">
    <div class="page-header">
        <h2>Transactions - {{ month }}</h2>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="document.getElementById('uploadModal').style.display='block'">
                Upload File
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('addModal').style.display='block'">
                Add Transaction
            </button>
        </div>
    </div>
    
    <div class="month-navigation">
        <a href="{{ url_for('transactions', month=month_num-1 if month_num > 1 else 12, year=year if month_num > 1 else year-1) }}" 
           class="btn btn-nav">‚Üê Previous</a>
        <span class="current-month">{{ month }}</span>
        <a href="{{ url_for('transactions', month=month_num+1 if month_num < 12 else 1, year=year if month_num < 12 else year+1) }}" 
           class="btn btn-nav">Next ‚Üí</a>
    </div>
    
    <div class="stats-summary">
        <div class="summary-item">
            <span>Income:</span>
            <span class="amount income">${{ "%.2f"|format(income) }}</span>
        </div>
        <div class="summary-item">
            <span>Expenses:</span>
            <span class="amount expense">${{ "%.2f"|format(expenses) }}</span>
        </div>
        <div class="summary-item">
            <span>Net:</span>
            <span class="amount {% if income - expenses >= 0 %}income{% else %}expense{% endif %}">
                ${{ "%.2f"|format(income - expenses) }}
            </span>
        </div>
    </div>
    
    {% if transactions %}
    <div class="transactions-table">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.date }}</td>
                    <td>{{ t.time }}</td>
                    <td>{{ t.name }}</td>
                    <td class="amount">${{ "%.2f"|format(t.amount) }}</td>
                    <td><span class="badge badge-{{ t.type }}">{{ t.type }}</span></td>
                    <td>
                        <button class="btn-icon delete" onclick="deleteTransaction({{ t.id }})">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="no-data">No transactions for this month.</p>
    {% endif %}
</div>

<!-- Add Transaction Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('addModal').style.display='none'">&times;</span>
        <h3>Add Transaction</h3>
        <form id="addTransactionForm">
            <div class="form-group">
                <label for="add_date">Date</label>
                <input type="date" id="add_date" name="date" required>
            </div>
            <div class="form-group">
                <label for="add_time">Time</label>
                <input type="time" id="add_time" name="time" required>
            </div>
            <div class="form-group">
                <label for="add_name">Description</label>
                <input type="text" id="add_name" name="name" required>
            </div>
            <div class="form-group">
                <label for="add_amount">Amount</label>
                <input type="number" id="add_amount" name="amount" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="add_type">Type</label>
                <select id="add_type" name="type" required>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Add Transaction</button>
        </form>
    </div>
</div>

<!-- Upload File Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('uploadModal').style.display='none'">&times;</span>
        <h3>Upload Transactions</h3>
        <p class="help-text">
            Upload a text file with one transaction per line.<br>
            Format: <code>date,time,description,amount,type</code><br>
            Example: <code>2024-01-15,14:30:00,Grocery Store,45.50,expense</code>
        </p>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="file">Select File</label>
                <input type="file" id="file" name="file" accept=".txt,.csv" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set default date and time
document.getElementById('add_date').valueAsDate = new Date();
const now = new Date();
document.getElementById('add_time').value = now.toTimeString().slice(0,5);

// Add transaction
document.getElementById('addTransactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const response = await fetch('{{ url_for("add_transaction") }}', {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert('Error: ' + result.message);
    }
});

// Upload file
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const response = await fetch('{{ url_for("upload_transactions") }}', {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    if (result.success) {
        alert(result.message);
        location.reload();
    } else {
        alert('Error: ' + result.message);
    }
});

// Delete transaction
async function deleteTransaction(id) {
    if (!confirm('Are you sure you want to delete this transaction?')) return;
    
    const response = await fetch(`{{ url_for("delete_transaction", transaction_id=0) }}`.replace('0', id), {
        method: 'POST'
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addModal');
    const uploadModal = document.getElementById('uploadModal');
    if (event.target == addModal) {
        addModal.style.display = 'none';
    }
    if (event.target == uploadModal) {
        uploadModal.style.display = 'none';
    }
}
</script>
{% endblock %}
